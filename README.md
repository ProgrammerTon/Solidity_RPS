# Solidity_RPS 6510503654 นายภัทรพล ณ เนตร
ไฟล์ที่สำคัญสำหรับการเขียน Smart Contract นี้ ประกอบด้วยไฟล์ RPS.sol , CommitReveal.sol และ TimeUnit.sol เท่านั้น ไฟล์ที่เหลือเป็นไฟล์ที่ผู้จัดทำนำมาใส่เพื่อทำความเข้าใจโค้ดที่อาจารย์สอนเพื่อการเรียนรู้และไฟล์ที่เกิดขึ้นจากการ compile และ deploy vm ใน Ethereum IDE
คอมเม้นต่างๆที่แนบในไฟล์ของ RPS.sol คือส่วนที่ผมได้เพิ่มลงไปต่อจาก RPS.sol เดิมเพื่อให้ทราว่าผมเพิ่มโค้ดอะไรบ้าง ส่วนอีกสองไฟล์ที่เหลือผมคงโค้ดตามเดิม

ขั้นตอนแรกผู้จัดทำได้นำโค้ดทั้งสามไฟล์ที่เป็นฉบับเริ่มต้นของอาจารย์เข้ามาใน GitHub และหลังจากนั้นได้ทำการดัดแปลงเพื่อให้ตรงกับความต้องการ เริ่มต้นด้วยการเพิ่ม Lizard Spock และการแทนค่าตัวแปรให้มันกับ Rock Paper Scissors เก่าเพื่อให้สามารถคำนวณผู้ชนะได้ง่ายๆ จาก logic สั้นๆ
กำหนด 0 - Rock, 1 - Spock , 2 - Paper , 3 - Lizard , 4 - Scissors ควบคู่กับวิธีการชนะเราสามารถสร้าง logic ตรวจหาผู้ชนะง่ายๆด้วย (p0Choice + 1) % 5 == p1Choice || (p0Choice + 3) % 5 == p1Choice)
ต่อมาการกำหนด Account ที่สามารถใช้ Contract ได้ วิธีการก็แค่สร้างอาร์เรย์ของราย account ที่สามารถเข้าได้ขึ้นมาแล้วก็เช็คเมื่อมีคนพยายามใช้งาน contract ว่าตรงกับในอาร์เรย์ไหม
สุดท้ายคือการทำให้ contract สามารถใช้งานได้ซ้ำ ก็ทำได้โดยการสร้างฟังก์ชันสำหรับ reset contract ให้กลับไปอยู่ค่าเริ่มต้นสำหรับ state variable ทุกตัว

จากที่กล่าวมาเป็นการแก้โค้ดที่อยู่แค่ในส่วนไฟล์ RPS.sol ต่อมาคือการเพิ่มความมั่นคงปลอดภัยสำหรับใช้งาน Contract โดยใช้ CommitReveal.sol และ TimeUnit.sol ผมเริ่มจากการ import ทั้งสองเข้า RPS และให้ RPS inherit จะทำให้เรียกใช้ฟังก์ชันได้
โค้ดที่ป้องกันการ lock เงินไว้ใน contract และ โค้ดส่วนที่จัดการกับความล่าช้าที่ผู้เล่นไม่ครบทั้งสองคนเสียที เป็นโค้ดที่เกี่ยวข้องกับไฟล์ TimeUnit.sol เพื่อกำหนดเวลาให้ผู้เล่นที่ไม่ทำการเลือกภายในระยะเวลาที่กำหนดสามารถถอนเงินออกจากเกมได้และต้องตรวจสอบว่าเวลาได้ผ่านไปเกินระยะเวลาที่กำหนดหรือไม่
กำหนดจับเวลาเริ่มต้นตั้งแต่มีการ add player ทั้งสองคนเข้ามาใน contract หลังจากนั้นจับเวลาที่พวกเขาใช้ในการใส่ input ถ้าเกินเวลาที่กำหนดก็ให้ตัดทันที โดยทำใน RPS เรียก setStartTime() เพือ่รับเวลาเริ่มต้นแล้วก็นับไปจนกว่าจะ timeout โดยผมตั้ง timeout ที่ 5 นาที ถ้าเลยก็คือ Reward กลับไป
ตามโค้ดที่ได้เขียนในฟังก์ชัน addplayer และหลังจากนั้นก็ขึ้น newRound()

ในส่วนโค้ดในการ commit และ reveal choice เมื่อได้ Choice มาแล้วเราต้องนำ Choice นั้นไปเข้า python choice_hiding_v2 และเราจะได้ input สำหรับใช้ใน getHash ฟังก์ชันขึ้นมา ด้วยวิธีนี้เมื่อมีคนพยายามทำ front-running เพื่อดู choice ของคนอื่น
สิ่งที่เขาจะเห็นคือ choice ที่ถูกเข้ารหัสไว้


